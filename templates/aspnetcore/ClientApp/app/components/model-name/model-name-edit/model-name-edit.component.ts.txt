import { Component, OnInit, OnDestroy } from '@angular/core';
import { NgRedux, select } from '@angular-redux/store';
import { IAppState } from './../../../store';
import { Router, ActivatedRoute } from '@angular/router';
import { {{titlecase}}ApiService } from '../../../services/{{dashlcase}}.api.service';
import { GET_ITEM_{{pucase}} } from '../../../actions';
import { tassign } from 'tassign';

@Component({
  selector: 'app-{{dashlcase}}-edit',
  templateUrl: './{{dashlcase}}-edit.component.html',
  styleUrls: ['./{{dashlcase}}-edit.component.css']
})
export class {{titlecase}}EditComponent implements OnInit, OnDestroy {
  isSaving: boolean;
  subscriptions = [];
  errors: any[] = [];
  item: any = {};

  @select((s: IAppState) => s.general.serverCallsInProgress)
  serverCallsInProgress;

  constructor(
    private route: ActivatedRoute,
    private router: Router,
    private ngRedux: NgRedux<IAppState>,
    private {{camelcase}}ApiService: {{titlecase}}ApiService
  ) {
      var store = this.ngRedux.getState();
      const storeItem: I{{titlecase}} = tassign({}, store.general.selected{{titlecase}});
      this.item = storeItem;
  }

  ngOnInit() {
  }

  saveForm() {
    if (this.isSaving) return;

    this.isSaving = true;
    this.{{camelcase}}ApiService.updateItemAsync(
      this.item,
      () => {
        this.isSaving = false;
        this.router.navigate(['/{{plcase}}']);
      },
      err => {
        this.isSaving = false;
        if (err) this.parseErrors(JSON.parse(err._body));
      }
    );
  }

  public parseErrors(errorJson) {
    this.errors = Object.getOwnPropertyNames(errorJson).map(er => {
      return errorJson[er].map(e => e);
    });
  }

  ngOnDestroy() {
    this.subscriptions.forEach(e => {
      if (typeof e === 'function') {
        e();
      } else {
        e.unsubscribe();
      }
    });
    this.subscriptions = null;
  }
}
